---
title:  | 
        Trabajo Práctico N° 1
subtitle: |
          Análisis de Series Temporales
      
          Maestría en Explotación de Datos y Gestión del Conocimiento
author: |
        Layla Scheli, Franco Lianza, Lucio Scalzo, Ignacio Mujica, Alexis Walker
date: |
      `r format(Sys.time(), '%d %B %Y')`


header-includes:
- \usepackage{titling}
- \usepackage{floatrow}
- \usepackage{lipsum}

- \renewcommand{\figurename}{Fig.}
- \renewcommand{\contentsname}{Índice}
- \renewcommand{\tablename}{Tabla}

- \pretitle{
      \begin{center}
      \thispagestyle{empty}
      \includegraphics[width=2in,height=2in]{logo.png}\LARGE\\
      \vskip 12em
  }
- \posttitle{\end{center}}

- \preauthor{
      \begin{center}
      \vskip 26em
  }
- \postauthor{\end{center}}
  
- \predate{\begin{center}}
- \postdate{
    \end{center}
    \vskip 4em
  }

output: 
  pdf_document
---
\thispagestyle{empty}
\newpage

\thispagestyle{empty}
\abstract
\lipsum[1]
\newpage

\thispagestyle{empty}
\tableofcontents
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message=FALSE}
paquetes <- c("readr", "tidyverse", "showtext", "forecast", "gridExtra",
              "tseries", "tsibble")

#, "gridExtra", "kableExtra", "tseries", "xts",
#              , "ggfortify", "lessR", "fable", "tsibble",
#              "tibbletime"

instalados <- paquetes %in% rownames(installed.packages())

if (any(instalados == FALSE)) {
  install.packages(paquetes[!instalados])
}

invisible(lapply(paquetes, library, character.only = TRUE))
```

```{r}
theme_set(theme_bw())
```

<!-- utilizades -->

```{r}
#TODO
showtext_auto()

incorrelation <- function(ts, type = c("Ljung-Box","Box-Pierce"), fitdf = 0){
  p_ljung_box = NULL
  s_ljung_box = NULL
  for(i in 0:(length(ts)/4)){
    p_ljung_box[i] = Box.test(ts, lag = i, type = type, fitdf = fitdf)$p.value
    s_ljung_box[i] = Box.test(ts, lag = i, type = type, fitdf = fitdf)$statistic
  }
  table = data.frame(j = 1:(length(ts)/4),
                     P_Value = p_ljung_box,
                     Statistic = s_ljung_box)
  return(table)
}

aic_matrix <- function(ts, p.order = 1, q.order = 1){
  
  require(forecast)
  
  aic_matrix = matrix(data = NA, nrow = p.order, ncol = q.order)
  for(i in 0:p.order){
    for(j in 0:q.order){
      aic = arima(ts,order = c(i,0,j))$aic
      aic_matrix[i,j] = aic
    }
  }
  rownames(aic_matrix) = c(1:p.order)
  colnames(aic_matrix) = c(1:q.order)
  
  return(aic_matrix)
}

```

<!-- datos -->

```{r}
raw_data <- read_csv(
  file = "https://docs.google.com/uc?id=16we_OjrEZxBUwaQKOh3QAoW5YwfcEg1E",
  col_types = cols(fecha = col_date(format = "%d/%m/%Y")))
```

```{r}
indice_precios_consumidor <- raw_data %>%
  select(fecha, indice_precios_consumidor_acumulada)

indice_salarios <- raw_data %>%
  select(fecha, indice_salarios_acumulada)

ts_indice_precios_consumidor <- indice_precios_consumidor$indice_precios_consumidor_acumulada %>%
  ts(frequency = 12, start = c(2017, 01))

ts_indice_salarios <- indice_salarios$indice_salarios_acumulada %>%
  ts(frequency = 12, start = c(2017, 01))
```

# Introducción

perdida de poder adquisitivo de los salarios frente a la inflación - ampliar

\lipsum[1]

\newpage

# Marco Teórico (acá deberán escribir los modelos)

\lipsum[1]

```{r fig.cap="Inflación versus Salarios", fig.height=4, fig.width=10}
ggplot(raw_data, aes(x = fecha)) +
  geom_line(aes(y = indice_precios_consumidor_acumulada), color = "red3") +
  geom_line(aes(y = indice_salarios_acumulada), color = "steelblue") +
  scale_y_continuous(
    name = "Índice de precio al consumidor",
    sec.axis = sec_axis(~., name = "Índice de salarios")) +
  theme(
    axis.title.y = element_text(color = "red3"),
    axis.title.y.right = element_text(color = "steelblue")
  ) +
  labs(x = "Tiempo") +
  ggtitle("Inflación versus Salarios")
```

\lipsum[2]

\newpage

## Diferenciación 

```{r}
indice_precios_consumidor_ndiffs <- ndiffs(ts_indice_precios_consumidor)
indice_salarios_ndiffs <- ndiffs(ts_indice_salarios)

indice_precios_consumidor_nsdiffs <- nsdiffs(ts_indice_precios_consumidor)
indice_salarios_nsdiffs <- nsdiffs(ts_indice_salarios)
```
hay que eliminar la tendencia y la estacionalidad de la serie para que pueda ser estacionaria.

Al diferenciar la serie se consigue que ésta sea estacionaria, 

### Índice IPC

número de diferenciaciones regulares: `r indice_precios_consumidor_ndiffs`

número de diferenciaciones estacionales: `r indice_precios_consumidor_nsdiffs`

Después de diferenciar gráfico x

```{r fig.cap="Índice de precio al consumidor y su tendencia", fig.height=3, fig.width=10}
dif_ts_indice_precios_consumidor <- ts_indice_precios_consumidor %>%
  diff(1) %>%
  diff(1)

dif_indice_precios_consumidor <- data.frame(
  indice_precios_consumidor = as.vector(dif_ts_indice_precios_consumidor),
  fecha = indice_precios_consumidor$fecha[c(-1, -2)])

ggplot(dif_indice_precios_consumidor, aes(x = fecha, y = indice_precios_consumidor)) +
  geom_line(color = "steelblue") +
  stat_smooth(method = "lm", col = "red3", formula = y ~ x + 0, size = 0.4, se = FALSE) +
  scale_y_continuous(name = "Índice de precio al consumidor") +
  labs(x = "Tiempo") +
  ggtitle("Índice de precio al consumidor")
```    



### Índice de Salarios

número de diferenciaciones regulares: `r indice_salarios_ndiffs`

número de diferenciaciones estacionales: `r indice_salarios_nsdiffs`

```{r fig.cap="Índice de Salarios y su tendencia", fig.height=3, fig.width=10}
dif_ts_indice_salarios <- ts_indice_salarios %>% diff(1)

dif_indice_salarios <- data.frame(
  indice_salarios = as.vector(dif_ts_indice_salarios),
  fecha = indice_salarios$fecha[c(-1)])

ggplot(dif_indice_salarios, aes(x = fecha, y = indice_salarios)) +
  geom_line(color = "steelblue") +
  stat_smooth(method = "lm", col = "red3", formula = y ~ x + 0, size = 0.4, se = FALSE) +
  scale_y_continuous(name = "Índice de Salarios") +
  labs(x = "Tiempo") +
  ggtitle("Índice de Salarios")
```

\newpage

## Funciones de autocorrelación y autocorrelación parcial

### Índice de precios al consumidor

```{r fig.cap="Índice de precios al consumidor", fig.height=5, fig.width=10}
old_par_setting <- par(no.readonly = TRUE)

par(mfrow=c(2,2))

data <- as.vector(dif_ts_indice_precios_consumidor)

acf(data, type = "correlation", main = "Función de Autocorrelación")
acf(data, type = "partial", main = "Función de Autocorrelación Parcial")
acf(data, type = "covariance", main = "Función de Autocovarianza")
plot(dif_ts_indice_precios_consumidor, main = "Serie", xlab="Tiempo", ylab = "")

par(old_par_setting)
```

### Índice de Salarios

```{r fig.cap="Índice de Salarios", fig.height=5, fig.width=10}
old_par_setting <- par(no.readonly = TRUE)

par(mfrow=c(2,2))

data <- as.vector(dif_ts_indice_salarios)

acf(data, type = "correlation", main = "Función de Autocorrelación")
acf(data, type = "partial", main = "Función de Autocorrelación Parcial")
acf(data, type = "covariance", main = "Función de Autocovarianza")
plot(dif_ts_indice_salarios, main = "Serie", xlab="Tiempo", ylab = "")

par(old_par_setting)
```


```{r}
# Box.test(dif_ts_indice_precios_consumidor, lag = 1, type = "Box-Pierce")
# Box.test(dif_ts_indice_precios_consumidor, lag = 1, type = "Ljung-Box")
# #white noise
# 
# Box.test(dif_ts_indice_salarios, lag = 1, type = "Box-Pierce")
# Box.test(dif_ts_indice_salarios, lag = 1, type = "Ljung-Box")
# # no white noise
#
# 
# Incorrelation(dif_ts_indice_precios_consumidor,"Box-Pierce")
# Incorrelation(dif_ts_indice_precios_consumidor,"Ljung-Box")
# 
# Incorrelation(dif_ts_indice_salarios,"Ljung-Box")
# Incorrelation(dif_ts_indice_salarios,"Box-Pierce")

```


## Modelos

### Estimación

```{r}
aic_matrix(dif_ts_indice_precios_consumidor, 5, 5)

modelo <- arima(dif_ts_indice_precios_consumidor,order = c(1,0,1))
modelo <- arima(dif_ts_indice_precios_consumidor,order = c(6,1,0))

coef(modelo)

summary(modelo)

```

```{r}
aic_matrix(dif_ts_indice_salarios, 3, 3)

modelo <- arima(dif_ts_indice_salarios, order = c(1,0,2))

coef(modelo)

summary(modelo)
```

### Análisis de los Residuos

```{r}

residuos <- resid(modelo)

#Histogram(residuos,density = T)

```



### Estimación

```{r}
modelo <- arma(ts_indice_salarios, order = c(1, 5), include.intercept = T)

coef(modelo)

summary(modelo)

```


### Análisis de los Residuos
```{r}
residuos <- resid(modelo)

#Histogram(residuos,density = T)


```


```{r}
train_data <- dif_ts_indice_precios_consumidor %>%
  as_tsibble() %>%
  filter_index(~ "2020-12")

test_data <- dif_ts_indice_precios_consumidor %>%
  as_tsibble() %>%
  filter_index("2021-01" ~ "2021-07")
```

```{r}
# forecast_data <- train_data %>%
#   model(arima = ARIMA(value), arima210 = ARIMA(value ~ pdq(3,2,0))) %>%
#   forecast(h = 7) %>%
#   rename(model = .model, mean = .mean)
```


```{r fig.cap="Forecast", fig.height=4, fig.width=10}
ggplot() +
  geom_line(data = train_data, aes(x = index, y = value), color = "blue") +
  geom_line(data = test_data, aes(x = index, y = value), color = "red3") +
  #geom_line(data = forecast_data, aes(x = index, y = mean, color = model)) +
  labs(x = "Tiempo") +
  ggtitle("Forecast")
```



\newpage

# Análisis de Resultados
\lipsum[1]
\newpage

# Conclusiones
\lipsum[1]
\newpage

# Referencias bibliográficas 3
\lipsum[1]
\newpage

# Apéndices

## Decomposición

### Índice de precios al consumidor

```{r fig.cap="Funciones", fig.height=5, fig.width=10, warning=FALSE}
decompose_plot <- dif_ts_indice_precios_consumidor %>%
  decompose(type = "additive") %>%
  autoplot(ts.colour = "steelblue")
decompose_plot + xlab("Tiempo") + ggtitle("Descoposición aditiva")
```

### Índice de Salarios

```{r fig.cap="Funciones", fig.height=5, fig.width=10, warning=FALSE}
decompose_plot <- dif_ts_indice_salarios %>%
  decompose(type = "additive") %>%
  autoplot(ts.colour = "steelblue")
decompose_plot + xlab("Tiempo") + ggtitle("Descoposición aditiva")
```






